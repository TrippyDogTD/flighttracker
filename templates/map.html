<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Edit Cyan Area</title>
<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"/>
<link rel="stylesheet" href="https://unpkg.com/leaflet-draw@1.0.4/dist/leaflet.draw.css"/>
<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
<script src="https://unpkg.com/leaflet-draw@1.0.4/dist/leaflet.draw.js"></script>
<style>
  html, body { height: 100%; margin: 0; }
  #map { height: 100%; }
  .leaflet-bar a {
    background: #f4e3b2 !important;
    color: #333 !important;
  }
  .save-btn {
    position: absolute;
    top: 10px;
    right: 20px;
    z-index: 1000;
    background: #d2b048;
    color: #222;
    padding: 10px 15px;
    border-radius: 6px;
    cursor: pointer;
    font-weight: bold;
    border: none;
  }
</style>
</head>
<body>
<button class="save-btn" onclick="saveArea()">ðŸ’¾ Save Area</button>
<div id="map"></div>

<script>
let map = L.map('map').setView([4.7, -74.1], 11);
L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
  maxZoom: 19,
}).addTo(map);

let editableLayer = new L.FeatureGroup().addTo(map);
let drawControl = new L.Control.Draw({
  edit: { featureGroup: editableLayer },
  draw: { polygon: true, polyline: false, circle: false, rectangle: false, marker: false, circlemarker: false }
});
map.addControl(drawControl);

let currentPolygon = null;

// Load current polygon
fetch("/current-area")
  .then(res => res.json())
  .then(data => {
    const coords = data.coords.map(([lon, lat]) => [lat, lon]);
    currentPolygon = L.polygon(coords, { color: "cyan" }).addTo(editableLayer);
    map.fitBounds(currentPolygon.getBounds());
  });

map.on(L.Draw.Event.CREATED, function (e) {
  editableLayer.clearLayers();
  currentPolygon = e.layer;
  editableLayer.addLayer(currentPolygon);
});

async function saveArea() {
  if (!currentPolygon) {
    alert("Draw a polygon first!");
    return;
  }
  const coords = currentPolygon.getLatLngs()[0].map(p => [p.lng, p.lat]);
  const res = await fetch("/current-area", {
    method: "POST",
    headers: { "Content-Type": "application/json" },
    body: JSON.stringify({ coords })
  });
  const data = await res.json();
  alert("âœ… Area saved!");
}
</script>
</body>
</html>
