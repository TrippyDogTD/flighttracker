<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Edit Flight Area</title>
  <link rel="stylesheet" href="/static/styles.css" />
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
  <script src="https://unpkg.com/leaflet-draw@1.0.4/dist/leaflet.draw.js"></script>
  <link rel="stylesheet" href="https://unpkg.com/leaflet-draw@1.0.4/dist/leaflet.draw.css" />
</head>
<body>
  <h1>âœˆ Edit Tracking Area</h1>
  <div id="map"></div>
  <button id="save">ðŸ’¾ Save Area</button>
  <button onclick="window.location='/'">â¬… Back</button>

  <script>
    const map = L.map("map").setView([4.7, -74.1], 11);
    L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png").addTo(map);
    const drawnItems = new L.FeatureGroup().addTo(map);

    const drawControl = new L.Control.Draw({
      edit: { featureGroup: drawnItems },
      draw: { polygon: true, rectangle: true, circle: false, marker: false }
    });
    map.addControl(drawControl);

    let currentLayer = null;

    map.on(L.Draw.Event.CREATED, function (e) {
      if (currentLayer) drawnItems.removeLayer(currentLayer);
      currentLayer = e.layer;
      drawnItems.addLayer(currentLayer);
    });

    document.getElementById("save").onclick = async () => {
      if (!currentLayer) return alert("Draw an area first!");
      const latlngs = currentLayer.getLatLngs()[0].map(p => ({ lat: p.lat, lng: p.lng }));
      const bounds = currentLayer.getBounds();
      const data = {
        points: latlngs,
        bounds: {
          tl_y: bounds.getNorth(),
          tl_x: bounds.getWest(),
          br_y: bounds.getSouth(),
          br_x: bounds.getEast(),
        },
      };
      await fetch("/update-area", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify(data),
      });
      alert("âœ… Area saved!");
    };
  </script>
</body>
</html>
