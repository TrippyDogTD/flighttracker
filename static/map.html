<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
  <title>Edit Tracking Areas ✈</title>
  <link rel="stylesheet" href="/static/styles.css" />
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
  <link rel="stylesheet" href="https://unpkg.com/leaflet-draw@1.0.4/dist/leaflet.draw.css" />
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
  <script src="https://unpkg.com/leaflet-draw@1.0.4/dist/leaflet.draw.js"></script>

  <style>
    body { margin: 0; background: #000; color: #ffd84b; font-family: "IBM Plex Mono", monospace; }
    #map { height: 100vh; width: 100vw; max-width: 100%; }

    .toolbar {
      position: absolute;
      top: 15px;
      left: 15px;
      z-index: 1000;
      background: rgba(0, 0, 0, 0.85);
      border: 1px solid #ffda0040;
      border-radius: 10px;
      padding: 10px 15px;
      color: #ffd84b;
      font-family: "IBM Plex Mono", monospace;
      box-shadow: 0 0 20px #ffda0040;
    }

    select, button {
      font-family: inherit;
      font-size: 0.9rem;
      background: #111;
      color: #ffd84b;
      border: 1px solid #ffda0040;
      border-radius: 6px;
      padding: 5px 10px;
      margin: 5px 3px;
      cursor: pointer;
    }

    button:hover { background: #222; box-shadow: 0 0 10px #ffda0030; }
    h1 { font-size: 1rem; margin: 0 0 5px 0; text-shadow: 0 0 10px #ffec7a; }

    /* move Leaflet controls down by ~10 cm (~180px visually) */
    .leaflet-top.leaflet-left { top: 180px !important; }
  </style>
</head>
<body>
  <div class="toolbar">
    <h1>✈ Area Manager</h1>
    <div>
      <label>Saved Areas:</label>
      <select id="areaSelect">
        <option value="">-- Loading... --</option>
      </select>
    </div>
    <div>
      <button id="saveArea">💾 Save New</button>
      <button id="useArea">✈ Use</button>
      <button onclick="window.location='/'">⬅ Back</button>
    </div>
  </div>

  <div id="map"></div>

  <script>
    const map = L.map("map").setView([4.7, -74.1], 11);
    L.tileLayer("https://tile.openstreetmap.org/{z}/{x}/{y}.png").addTo(map);
    const drawnItems = new L.FeatureGroup().addTo(map);
    const drawControl = new L.Control.Draw({
      edit: { featureGroup: drawnItems },
      draw: { polygon: true, rectangle: false, circle: false, marker: false, polyline: false }
    });
    map.addControl(drawControl);

    let currentLayer = null;
    let activeLayer = null;
    let savedAreas = [];

    async function loadSavedAreas() {
      try {
        const res = await fetch("/get-area?name=__list__");
        const data = await res.json();
        savedAreas = data.areas || [];
      } catch { savedAreas = []; }

      const sel = document.getElementById("areaSelect");
      sel.innerHTML = "";
      const optDefault = document.createElement("option");
      optDefault.textContent = "-- Select Area --";
      optDefault.value = "";
      sel.appendChild(optDefault);
      savedAreas.forEach(a => {
        const opt = document.createElement("option");
        opt.value = a;
        opt.textContent = a;
        sel.appendChild(opt);
      });
    }

    async function loadAreaByName(name, color = "cyan") {
      if (!name) return;
      try {
        const res = await fetch(`/get-area?name=${encodeURIComponent(name)}`);
        const data = await res.json();
        if (data.error) return alert("Area not found!");
        if (currentLayer && color === "cyan") drawnItems.removeLayer(currentLayer);
        const layer = L.polygon(data.points, { color, weight: 3, fillOpacity: 0.2 }).addTo(drawnItems);
        map.fitBounds(layer.getBounds());
        if (color === "cyan") currentLayer = layer;
        else if (color === "lime") activeLayer = layer;
      } catch (err) {
        console.error("Error loading area:", err);
      }
    }

    // 🔁 Auto-load when selecting from dropdown
    document.getElementById("areaSelect").addEventListener("change", (e) => {
      const name = e.target.value;
      if (name) loadAreaByName(name);
    });

    map.on(L.Draw.Event.CREATED, function (e) {
      if (currentLayer) drawnItems.removeLayer(currentLayer);
      currentLayer = e.layer;
      drawnItems.addLayer(currentLayer);
    });

    document.getElementById("saveArea").onclick = async () => {
      if (!currentLayer) return alert("❌ Draw an area first!");
      const name = prompt("Enter a name for this area:");
      if (!name) return;
      const latlngs = currentLayer.getLatLngs()[0].map(p => ({ lat: p.lat, lng: p.lng }));
      const body = { name, points: latlngs };
      const res = await fetch("/save-area", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify(body)
      });
      if (res.ok) {
        alert("✅ Area saved!");
        await loadSavedAreas();
        document.getElementById("areaSelect").value = name;
        loadAreaByName(name);
      } else alert("⚠️ Failed to save area.");
    };

    // ✈ Use button — set active + return to board
    document.getElementById("useArea").onclick = async () => {
      const name = document.getElementById("areaSelect").value;
      if (!name) return alert("Select an area first.");
      const res = await fetch(`/set-active?name=${encodeURIComponent(name)}`, { method: "POST" });
      if (res.ok) {
        alert(`✅ '${name}' set as active.`);
        window.location = "/";  // go back to flight board
      } else alert("⚠️ Could not set active area.");
    };

    // 🟢 Highlight current active area on startup
    async function showActiveArea() {
      try {
        const res = await fetch("/data/active_area.json");
        if (!res.ok) return;
        const data = await res.json();
        if (!data.name || !data.points) return;
        await loadAreaByName(data.name, "lime");
      } catch (e) {
        console.warn("No active area loaded:", e);
      }
    }

    (async () => {
      await loadSavedAreas();
      await showActiveArea();
    })();
  </script>
</body>
</html>
